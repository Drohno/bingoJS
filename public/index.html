<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bingo Socket.IO</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        text-align: center;
        padding: 18px;
      }
      .carton {
        display: inline-block;
        background: white;
        border: 2px solid #333;
        border-radius: 8px;
        margin: 8px;
        padding: 10px;
      }
      .fila {
        display: flex;
        justify-content: center;
        margin-bottom: 6px;
      }
      .num {
        width: 35px;
        height: 35px;
        line-height: 35px;
        border: 1px solid #aaa;
        margin: 2px;
        border-radius: 5px;
        background: #eee;
        font-weight: bold;
      }
      .num.marcado {
        background: #4caf50;
        color: white;
      }
      #numeros-salidos {
        margin-top: 12px;
        font-size: 1.05em;
      }
      button {
        padding: 8px 14px;
        margin: 6px;
        font-size: 1rem;
        cursor: pointer;
      }
      #log {
        max-height: 140px;
        overflow: auto;
        text-align: left;
        margin: 10px auto;
        width: 90%;
        background: #fff;
        border: 1px solid #ddd;
        padding: 8px;
        border-radius: 6px;
      }
      .small {
        font-size: 0.9em;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>🎱 Bingo con Socket.IO</h1>

    <div>
      <label
        >Cartones por cliente:
        <select id="num-cartones">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3" selected>3</option>
        </select>
      </label>
      <button id="pedir-cartones">Pedir cartones</button>
      <button id="iniciar">Iniciar juego (cualquiera puede)</button>
      <button id="estado-btn">Pedir estado</button>
    </div>

    <div id="cartones-container"></div>

    <div id="numeros-salidos"></div>
    <div id="estado" class="small"></div>

    <h3>Log</h3>
    <div id="log"></div>

    <!-- Socket.IO client (CDN) -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const cartonesContainer = document.getElementById("cartones-container");
      const numerosSalidosDiv = document.getElementById("numeros-salidos");
      const estadoDiv = document.getElementById("estado");
      const logDiv = document.getElementById("log");
      const pedirBtn = document.getElementById("pedir-cartones");
      const iniciarBtn = document.getElementById("iniciar");
      const estadoBtn = document.getElementById("estado-btn");

      function log(msg) {
        const now = new Date().toLocaleTimeString();
        logDiv.innerHTML = `<div>[${now}] ${msg}</div>` + logDiv.innerHTML;
      }

      // Pedir cartones al servidor
      pedirBtn.addEventListener("click", () => {
        const cantidad = parseInt(
          document.getElementById("num-cartones").value,
          10
        );
        socket.emit("request-cartones", { cantidad });
        log(`Solicitados ${cantidad} cartón(es) al servidor`);
      });

      iniciarBtn.addEventListener("click", () => {
        socket.emit("iniciar-juego");
        log("Solicitud de iniciar juego enviada");
      });

      estadoBtn.addEventListener("click", () => {
        socket.emit("estado");
        log("Solicitado estado al servidor");
      });

      // Render cartones enviados por servidor
      socket.on("cartones", ({ cartones }) => {
        cartonesContainer.innerHTML = "";
        cartones.forEach((carton, i) => {
          const div = document.createElement("div");
          div.className = "carton";
          div.id = `carton-${i}`;
          const title = document.createElement("h3");
          title.textContent = `Cartón ${i + 1}`;
          div.appendChild(title);
          carton.filas.forEach((fila) => {
            const filaDiv = document.createElement("div");
            filaDiv.className = "fila";
            fila.forEach((n) => {
              const nd = document.createElement("div");
              nd.className = "num";
              nd.textContent = n;
              nd.dataset.num = n;
              filaDiv.appendChild(nd);
            });
            div.appendChild(filaDiv);
          });
          cartonesContainer.appendChild(div);
        });
        log(`Recibidos ${cartones.length} cartón(es) del servidor`);
      });

      // estado inicial
      socket.on("estado-inicial", (data) => {
        estadoDiv.textContent = data.juegoEnCurso
          ? "Juego en curso"
          : "Juego detenido";
        if (data.numerosSalidos && data.numerosSalidos.length) {
          numerosSalidosDiv.textContent = `Números salidos: ${data.numerosSalidos.join(
            ", "
          )}`;
        } else {
          numerosSalidosDiv.textContent = "Números salidos: (ninguno)";
        }
      });

      // cada vez que sale un número
      socket.on("numero", ({ numero, numerosSalidos, quedan }) => {
        numerosSalidosDiv.textContent = `Números salidos: ${numerosSalidos.join(
          ", "
        )}`;
        estadoDiv.textContent = `Quedan ${quedan} números`;
        marcarNumeroEnUI(numero);
        log(`Número salido: ${numero} (quedan ${quedan})`);
      });

      // Línea para este cliente
      socket.on("linea", ({ cartonIndex, filaIndex, mensaje }) => {
        log(`LÍNEA - ${mensaje}`);
        // destacar la fila indicada
        const cartonEl = document.getElementById(`carton-${cartonIndex}`);
        if (cartonEl) {
          const filaEl = cartonEl.querySelectorAll(".fila")[filaIndex];
          if (filaEl)
            filaEl.style.boxShadow = "0 0 10px 3px rgba(255,215,0,0.6)";
        }
      });

      // Bingo para este cliente
      socket.on("bingo", ({ cartonIndex, mensaje }) => {
        log(`BINGO - ${mensaje}`);
        alert(`🎉 ${mensaje}`);
      });

      // anuncios generales (alguien ha hecho linea o bingo)
      socket.on("anuncio", ({ tipo, socketId, cartonIndex }) => {
        if (tipo === "linea") {
          log(
            `🔔 Anuncio: alguien ha hecho LÍNEA (socket ${socketId}, cartón ${
              cartonIndex + 1
            })`
          );
        } else if (tipo === "bingo") {
          log(
            `🔔 Anuncio: alguien ha hecho BINGO (socket ${socketId}, cartón ${
              cartonIndex + 1
            })`
          );
        }
      });

      socket.on("juego-iniciado", ({ quedan }) => {
        estadoDiv.textContent = `Juego en curso — quedan ${quedan} números`;
        log("Juego iniciado en servidor");
      });

      socket.on("juego-terminado", ({ razon, numerosSalidos, quedan }) => {
        estadoDiv.textContent = `Juego terminado: ${razon} (salidos: ${numerosSalidos.length})`;
        log(`Juego terminado: ${razon}`);
      });

      socket.on("estado-actual", (data) => {
        estadoDiv.textContent = data.juegoEnCurso
          ? `Juego en curso — quedan ${data.quedan}`
          : "Juego detenido";
        if (data.numerosSalidos)
          numerosSalidosDiv.textContent = `Números salidos: ${data.numerosSalidos.join(
            ", "
          )}`;
        log("Estado actual recibido");
      });

      socket.on("connect", () => {
        log(`Conectado al servidor (${socket.id})`);
      });

      socket.on("disconnect", () => {
        log("Desconectado del servidor");
      });

      // marcar número en la UI (si aparece en los cartones del cliente)
      function marcarNumeroEnUI(num) {
        document.querySelectorAll(`.num`).forEach((el) => {
          if (parseInt(el.dataset.num, 10) === num) {
            el.classList.add("marcado");
          }
        });
      }
    </script>
  </body>
</html>
